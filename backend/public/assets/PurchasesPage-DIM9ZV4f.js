import{a as se,j as e,L as X,k as re,h as oe,w as me,t as L,l as he,n as ae,B as ne,o as xe,f as ye,S as ve}from"./index-BnL1Xpg8.js";import{r as a}from"./vendor-react-DsCSLZ3L.js";import{D as je}from"./DataTable-L1WogRDr.js";import{S as J}from"./Select-C1tkZ5oT.js";import{M as Z}from"./Modal-D_3ZWCmE.js";import{C as ee}from"./CurrencyInput-DAqk0Rkb.js";import{F as k}from"./FormField-Yls4ILqE.js";import{F as ge}from"./FormError-DDW1e3jQ.js";import{F as be}from"./FormActions-yCzbOGcx.js";import"./vendor-utils-DMdnf9MG.js";import"./vendor-charts-DGg1Za7c.js";import"./vendor-icons-DU-kWQ55.js";function fe({isOpen:o,onClose:v,onSuccess:D}){const{t:n,locale:s,direction:f}=se(),[i,T]=a.useState([]),[M,F]=a.useState([]),[E,R]=a.useState([]),[C,j]=a.useState(!0),[q,N]=a.useState(null),[P,I]=a.useState(null),[d,A]=a.useState(""),[_,g]=a.useState(new Date().toISOString().split("T")[0]),[W,c]=a.useState(""),[u,w]=a.useState(0),[y,B]=a.useState(0),[K,Y]=a.useState(""),[x,U]=a.useState([]),[z,l]=a.useState(!1),[h,t]=a.useState("");a.useEffect(()=>{if(!o)return;(async()=>{j(!0);try{const[m,S,O]=await Promise.all([re.listAll(),oe.list({per_page:1e3}),me.list()]);T(m),F(S.data),R(O),O.length>0&&!P&&I(O[0].id)}catch{L.error(n("error.load_failed","Failed to load data"))}finally{j(!1)}})()},[o,n,P]);const p=()=>{N(null),A(""),g(new Date().toISOString().split("T")[0]),c(""),w(0),B(0),Y(""),U([]),t("")},b=()=>{p(),v()},Q=i.map(r=>({value:r.id,label:r.name})),ce=E.map(r=>({value:r.id,label:r.name})),le=a.useMemo(()=>{if(!h)return M.slice(0,20);const r=h.toLowerCase();return M.filter(m=>m.name.toLowerCase().includes(r)||m.sku&&m.sku.toLowerCase().includes(r)||m.barcode?.toLowerCase().includes(r)).slice(0,20)},[M,h]),ie=r=>{if(x.some(m=>m.product_id===r.id)){L.warning(n("purchases.already_added","Product already added"));return}U([...x,{product_id:r.id,product:r,quantity:1,unit_cost:r.cost_price||0,tax_rate:0,discount_amount:0,update_cost_price:!1}]),t("")},te=(r,m,S)=>{U(x.map((O,$)=>$===r?{...O,[m]:S}:O))},de=r=>{U(x.filter((m,S)=>S!==r))},G=a.useMemo(()=>{const r=x.reduce(($,H)=>$+H.quantity*H.unit_cost,0),m=x.reduce(($,H)=>$+(H.discount_amount||0),0),S=x.reduce(($,H)=>{const pe=H.quantity*H.unit_cost;return $+pe*(H.tax_rate||0)/100},0),O=r-m-u+S+y;return{subtotal:r,itemDiscounts:m,taxTotal:S,total:O}},[x,u,y]),V=r=>new Intl.NumberFormat(s==="ar"?"ar-LY":"en-LY",{style:"currency",currency:"LYD",minimumFractionDigits:3}).format(r),ue=async()=>{if(!q){L.error(n("purchases.select_supplier","Please select a supplier"));return}if(x.length===0){L.error(n("purchases.no_items","Please add at least one item"));return}l(!0);try{await he.create({supplier_id:q,warehouse_id:P||void 0,supplier_invoice_number:d||void 0,invoice_date:_,due_date:W||void 0,discount_amount:u,shipping_cost:y,notes:K||void 0,items:x.map(({product:r,...m})=>m)}),L.success(n("purchases.created","Purchase invoice created and stock updated")),b(),D()}catch{L.error(n("error.create_failed","Failed to create invoice"))}finally{l(!1)}};return e.jsx(Z,{isOpen:o,onClose:b,title:n("purchases.create","New Purchase Invoice"),size:"xl",children:C?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(X,{size:"lg"})}):e.jsxs("div",{className:"space-y-6",dir:f,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(k,{label:n("purchases.supplier","Supplier"),required:!0,children:e.jsx(J,{value:q,onChange:r=>N(r),options:Q,placeholder:n("purchases.select_supplier","Select supplier"),searchable:!0})}),e.jsx(k,{label:n("purchases.warehouse","Warehouse"),children:e.jsx(J,{value:P,onChange:r=>I(r),options:ce,placeholder:n("purchases.select_warehouse","Select warehouse")})}),e.jsx(k,{label:n("purchases.supplier_invoice","Supplier Invoice #"),children:e.jsx("input",{type:"text",value:d,onChange:r=>A(r.target.value),className:"input",placeholder:n("purchases.supplier_invoice_placeholder","Enter supplier invoice number...")})}),e.jsx(k,{label:n("purchases.date","Invoice Date"),required:!0,children:e.jsx("input",{type:"date",value:_,onChange:r=>g(r.target.value),className:"input"})}),e.jsx(k,{label:n("purchases.due_date","Due Date"),children:e.jsx("input",{type:"date",value:W,onChange:r=>c(r.target.value),className:"input"})})]}),e.jsxs("div",{className:"border rounded-lg p-4 dark:border-zinc-700",children:[e.jsx("h3",{className:"font-semibold mb-4",children:n("purchases.items","Items")}),e.jsxs("div",{className:"mb-4",children:[e.jsx("input",{type:"text",value:h,onChange:r=>t(r.target.value),className:"input",placeholder:n("purchases.search_products","Search by name, SKU, barcode...")}),h&&le.length>0&&e.jsx("div",{className:"mt-2 border rounded-lg max-h-48 overflow-y-auto dark:border-zinc-700",children:le.map(r=>e.jsxs("button",{type:"button",onClick:()=>ie(r),className:"w-full px-4 py-2 text-start hover:bg-gray-100 dark:hover:bg-zinc-800 flex justify-between items-center",children:[e.jsx("span",{children:r.name}),e.jsx("span",{className:"text-gray-500 text-sm",children:r.sku})]},r.id))})]}),x.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:n("purchases.no_items","No items added yet")}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b dark:border-zinc-700",children:[e.jsx("th",{className:"text-start py-2 px-2",children:n("common.product","Product")}),e.jsx("th",{className:"text-center py-2 px-2 w-20",children:n("purchases.qty","Qty")}),e.jsx("th",{className:"text-center py-2 px-2 w-28",children:n("purchases.unit_cost","Cost")}),e.jsx("th",{className:"text-center py-2 px-2 w-20",children:n("purchases.tax_rate","Tax %")}),e.jsx("th",{className:"text-end py-2 px-2 w-28",children:n("purchases.subtotal","Subtotal")}),e.jsx("th",{className:"w-10"})]})}),e.jsx("tbody",{children:x.map((r,m)=>e.jsxs("tr",{className:"border-b dark:border-zinc-700",children:[e.jsxs("td",{className:"py-2 px-2",children:[e.jsx("div",{className:"font-medium",children:r.product?.name}),e.jsx("div",{className:"text-gray-500 text-xs",children:r.product?.sku})]}),e.jsx("td",{className:"py-2 px-2",children:e.jsx("input",{type:"number",min:"1",value:r.quantity,onChange:S=>te(m,"quantity",parseInt(S.target.value)||1),className:"input text-center w-full"})}),e.jsx("td",{className:"py-2 px-2",children:e.jsx(ee,{value:r.unit_cost,onChange:S=>te(m,"unit_cost",S||0)})}),e.jsx("td",{className:"py-2 px-2",children:e.jsx("input",{type:"number",min:"0",max:"100",step:"0.01",value:r.tax_rate||0,onChange:S=>te(m,"tax_rate",parseFloat(S.target.value)||0),className:"input text-center w-full"})}),e.jsx("td",{className:"py-2 px-2 text-end font-medium",children:V(r.quantity*r.unit_cost)}),e.jsx("td",{className:"py-2 px-2",children:e.jsx("button",{type:"button",onClick:()=>de(m),className:"text-red-500 hover:text-red-700 p-1",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})})]},m))})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(k,{label:n("purchases.discount","Discount"),children:e.jsx(ee,{value:u,onChange:r=>w(r||0)})}),e.jsx(k,{label:n("purchases.shipping","Shipping"),children:e.jsx(ee,{value:y,onChange:r=>B(r||0)})}),e.jsx(k,{label:n("purchases.notes","Notes"),children:e.jsx("textarea",{value:K,onChange:r=>Y(r.target.value),rows:2,className:"input",placeholder:n("purchases.notes_placeholder","Optional notes...")})})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-zinc-800 rounded-lg p-4 space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:n("purchases.subtotal","Subtotal")}),e.jsx("span",{children:V(G.subtotal)})]}),G.itemDiscounts>0&&e.jsxs("div",{className:"flex justify-between text-red-600",children:[e.jsx("span",{children:n("purchases.discount","Item Discounts")}),e.jsxs("span",{children:["-",V(G.itemDiscounts)]})]}),u>0&&e.jsxs("div",{className:"flex justify-between text-red-600",children:[e.jsx("span",{children:n("purchases.discount","Invoice Discount")}),e.jsxs("span",{children:["-",V(u)]})]}),G.taxTotal>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:n("purchases.tax_total","Tax")}),e.jsx("span",{children:V(G.taxTotal)})]}),y>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:n("purchases.shipping","Shipping")}),e.jsx("span",{children:V(y)})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold pt-2 border-t dark:border-zinc-600",children:[e.jsx("span",{children:n("purchases.total","Total")}),e.jsx("span",{children:V(G.total)})]})]})]}),e.jsx("div",{className:"bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg p-3 text-sm text-blue-800 dark:text-blue-200",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("svg",{className:"w-5 h-5 flex-shrink-0 mt-0.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("span",{children:n("purchases.stock_updated","Stock will be automatically increased when this invoice is created.")})]})}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t dark:border-zinc-700",children:[e.jsx("button",{type:"button",onClick:b,className:"btn btn-secondary",disabled:z,children:n("common.cancel","Cancel")}),e.jsxs("button",{type:"button",onClick:ue,className:"btn btn-primary",disabled:z||x.length===0,children:[z?e.jsx(X,{size:"sm",className:"mr-2"}):null,n("purchases.create","Create Invoice")]})]})]})})}function Ne({isOpen:o,onClose:v,invoiceId:D,onPaymentRecorded:n}){const{t:s,locale:f}=se(),[i,T]=a.useState(null),[M,F]=a.useState(!0),[E,R]=a.useState(!1),[C,j]=a.useState(0),[q,N]=a.useState(""),[P,I]=a.useState(!1),d=a.useCallback(c=>{const u=typeof c=="string"?parseFloat(c):c;return new Intl.NumberFormat(f==="ar"?"ar-LY":"en-LY",{style:"currency",currency:"LYD",minimumFractionDigits:3}).format(u)},[f]);a.useEffect(()=>{if(!o||!D)return;(async()=>{F(!0);try{const u=await ae.get(D);T(u);const w=Number(u.total)-Number(u.paid_amount);j(w>0?w:0)}catch{L.error(s("error.load_failed","Failed to load invoice")),v()}finally{F(!1)}})()},[o,D,s,v]),a.useEffect(()=>{o||(T(null),R(!1),j(0),N(""))},[o]);const A=c=>{const u={unpaid:"default",partial:"warning",paid:"success"},w={unpaid:s("purchases.unpaid","Unpaid"),partial:s("purchases.partial_paid","Partial"),paid:s("purchases.paid","Paid")};return e.jsx(ne,{variant:u[c],dot:!0,children:w[c]})},_=async()=>{if(!(!i||C<=0)){I(!0);try{const c=await ae.recordPayment(i.id,{amount:C,notes:q||void 0});T({...i,paid_amount:c.paid_amount,payment_status:c.payment_status}),L.success(s("purchases.payment_recorded","Payment recorded successfully")),R(!1),N("");const u=Number(c.total)-Number(c.paid_amount);j(u>0?u:0),n?.()}catch(c){L.error(c instanceof Error?c.message:s("error.action_failed","Failed to record payment"))}finally{I(!1)}}},g=i?Number(i.total)-Number(i.paid_amount):0,W=i&&i.payment_status!=="paid";return M?e.jsx(Z,{isOpen:o,onClose:v,title:s("purchases.invoice_details","Invoice Details"),children:e.jsx("div",{className:"py-12",children:e.jsx(X,{})})}):i?e.jsxs(Z,{isOpen:o,onClose:v,title:`${s("purchases.invoice","Invoice")} ${i.invoice_number}`,size:"lg",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 p-4 rounded-lg",style:{backgroundColor:"var(--color-gray-50)"},children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm",style:{color:"var(--color-gray-500)"},children:s("purchases.supplier","Supplier")}),e.jsx("div",{className:"font-medium",style:{color:"var(--color-gray-900)"},children:i.supplier?.name})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm",style:{color:"var(--color-gray-500)"},children:s("purchases.payment","Payment")}),e.jsx("div",{className:"mt-1",children:A(i.payment_status)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm",style:{color:"var(--color-gray-500)"},children:s("purchases.date","Date")}),e.jsx("div",{className:"font-medium",style:{color:"var(--color-gray-900)"},children:new Date(i.invoice_date).toLocaleDateString(f)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm",style:{color:"var(--color-gray-500)"},children:s("purchases.total","Total")}),e.jsx("div",{className:"font-semibold",style:{color:"var(--color-primary-600)"},children:d(i.total)})]})]}),i.supplier_invoice_number&&e.jsxs("div",{className:"mb-4 p-3 rounded-lg",style:{backgroundColor:"var(--color-gray-50)"},children:[e.jsxs("span",{className:"text-sm",style:{color:"var(--color-gray-500)"},children:[s("purchases.supplier_invoice","Supplier Invoice #"),":"," "]}),e.jsx("span",{className:"font-mono font-medium",style:{color:"var(--color-gray-900)"},children:i.supplier_invoice_number})]}),e.jsx("div",{className:"border rounded-lg overflow-hidden mb-6",style:{borderColor:"var(--color-gray-200)"},children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{style:{backgroundColor:"var(--color-gray-50)"},children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-start",children:s("products.name","Product")}),e.jsx("th",{className:"px-4 py-2 text-center",children:s("purchases.qty","Qty")}),e.jsx("th",{className:"px-4 py-2 text-end",children:s("purchases.unit_cost","Unit Cost")}),e.jsx("th",{className:"px-4 py-2 text-end",children:s("purchases.subtotal","Subtotal")})]})}),e.jsx("tbody",{children:i.items?.map(c=>e.jsxs("tr",{className:"border-t",style:{borderColor:"var(--color-gray-100)"},children:[e.jsxs("td",{className:"px-4 py-2",children:[e.jsx("div",{style:{color:"var(--color-gray-900)"},children:c.product?.name}),e.jsx("div",{className:"text-xs",style:{color:"var(--color-gray-500)"},children:c.product?.sku})]}),e.jsx("td",{className:"px-4 py-2 text-center",style:{color:"var(--color-gray-600)"},children:c.quantity}),e.jsx("td",{className:"px-4 py-2 text-end",style:{color:"var(--color-gray-600)"},children:d(c.unit_cost)}),e.jsx("td",{className:"px-4 py-2 text-end font-medium",style:{color:"var(--color-gray-900)"},children:d(c.line_total)})]},c.id))}),e.jsxs("tfoot",{style:{backgroundColor:"var(--color-gray-50)"},children:[i.discount_amount>0&&e.jsxs("tr",{className:"border-t",style:{borderColor:"var(--color-gray-200)"},children:[e.jsxs("td",{colSpan:3,className:"px-4 py-2 text-end",children:[s("common.discount","Discount"),":"]}),e.jsxs("td",{className:"px-4 py-2 text-end",style:{color:"var(--color-danger-600)"},children:["-",d(i.discount_amount)]})]}),i.shipping_cost>0&&e.jsxs("tr",{className:"border-t",style:{borderColor:"var(--color-gray-200)"},children:[e.jsxs("td",{colSpan:3,className:"px-4 py-2 text-end",children:[s("common.shipping","Shipping"),":"]}),e.jsx("td",{className:"px-4 py-2 text-end",children:d(i.shipping_cost)})]}),e.jsxs("tr",{className:"border-t",style:{borderColor:"var(--color-gray-200)"},children:[e.jsxs("td",{colSpan:3,className:"px-4 py-3 text-end font-semibold",children:[s("common.total","Total"),":"]}),e.jsx("td",{className:"px-4 py-3 text-end font-bold",style:{color:"var(--color-primary-600)"},children:d(i.total)})]})]})]})}),e.jsxs("div",{className:"mb-6 p-4 rounded-lg border",style:{borderColor:"var(--color-gray-200)"},children:[e.jsx("h4",{className:"font-semibold mb-3",style:{color:"var(--color-gray-900)"},children:s("purchases.payment_summary","Payment Summary")}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{style:{color:"var(--color-gray-600)"},children:[s("purchases.total_amount","Total Amount"),":"]}),e.jsx("span",{className:"font-medium",style:{color:"var(--color-gray-900)"},children:d(i.total)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{style:{color:"var(--color-gray-600)"},children:[s("purchases.paid_amount","Paid Amount"),":"]}),e.jsx("span",{className:"font-medium",style:{color:"var(--color-success-600)"},children:d(i.paid_amount)})]}),e.jsxs("div",{className:"flex justify-between text-sm pt-2 border-t",style:{borderColor:"var(--color-gray-200)"},children:[e.jsxs("span",{className:"font-medium",style:{color:"var(--color-gray-700)"},children:[s("purchases.remaining","Remaining"),":"]}),e.jsx("span",{className:"font-bold",style:{color:g>0?"var(--color-danger-600)":"var(--color-success-600)"},children:d(g)})]})]})]}),E&&e.jsxs("div",{className:"mb-6 p-4 rounded-lg border",style:{borderColor:"var(--color-primary-200)",backgroundColor:"var(--color-primary-50)"},children:[e.jsx("h4",{className:"font-semibold mb-4",style:{color:"var(--color-gray-900)"},children:s("purchases.record_payment","Record Payment")}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(k,{label:s("purchases.payment_amount","Payment Amount"),required:!0,children:[e.jsx(ee,{value:C,onChange:c=>j(c??0),min:.001,max:g}),e.jsxs("p",{className:"text-xs mt-1",style:{color:"var(--color-gray-500)"},children:[s("purchases.max_payment","Maximum"),": ",d(g)]})]}),e.jsx(k,{label:s("purchases.payment_notes","Notes"),children:e.jsx("textarea",{value:q,onChange:c=>N(c.target.value),className:"input",rows:2,placeholder:s("purchases.payment_notes_placeholder","Optional payment notes...")})}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{onClick:()=>R(!1),className:"btn btn-secondary",disabled:P,children:s("common.cancel","Cancel")}),e.jsx("button",{onClick:_,className:"btn btn-primary",disabled:P||C<=0||C>g,children:P?e.jsxs(e.Fragment,{children:[e.jsx(X,{size:"sm"}),e.jsx("span",{className:"ms-2",children:s("common.saving","Saving...")})]}):s("purchases.record_payment","Record Payment")})]})]})]}),i.notes&&e.jsxs("div",{className:"mb-6 p-4 rounded-lg",style:{backgroundColor:"var(--color-gray-50)"},children:[e.jsx("div",{className:"text-sm mb-1",style:{color:"var(--color-gray-500)"},children:s("purchases.notes","Notes")}),e.jsx("div",{style:{color:"var(--color-gray-700)"},className:"whitespace-pre-wrap",children:i.notes})]}),e.jsxs("div",{className:"mb-6 p-3 rounded-lg border flex items-center gap-2",style:{backgroundColor:"var(--color-success-50)",borderColor:"var(--color-success-200)"},children:[e.jsx("svg",{className:"w-5 h-5",style:{color:"var(--color-success-600)"},fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),e.jsx("span",{className:"text-sm",style:{color:"var(--color-success-800)"},children:s("purchases.stock_updated","Inventory stock was updated when this invoice was created.")})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 pt-4 border-t",style:{borderColor:"var(--color-gray-200)"},children:[W&&!E&&e.jsxs("button",{onClick:()=>R(!0),className:"btn btn-success",children:[e.jsx("svg",{className:"w-4 h-4 me-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"})}),s("purchases.record_payment","Record Payment")]}),e.jsx("button",{onClick:v,className:"btn btn-secondary ms-auto",children:s("common.close","Close")})]})]}):null}function _e({isOpen:o,onClose:v,onSuccess:D,preselectedSupplierId:n}){const{t:s,locale:f}=se(),[i,T]=a.useState([]),[M,F]=a.useState([]),[E,R]=a.useState(!0),[C,j]=a.useState(0),[q,N]=a.useState(""),[P,I]=a.useState(""),[d,A]=a.useState([]),[_,g]=a.useState(""),[W,c]=a.useState(!1),[u,w]=a.useState(null),y=a.useCallback(t=>new Intl.NumberFormat(f==="ar"?"ar-LY":"en-LY",{style:"currency",currency:"LYD",minimumFractionDigits:3}).format(t),[f]);a.useEffect(()=>{if(!o)return;(async()=>{R(!0);try{const[p,b]=await Promise.all([re.listAll(),oe.list({per_page:100})]);T(p.filter(Q=>Q.is_active)),F(b.data)}catch{L.error(s("error.load_failed","Failed to load data"))}finally{R(!1)}})()},[o,s]),a.useEffect(()=>{o&&(j(n||0),N(""),I(""),A([]),g(""),w(null))},[o,n]);const B=a.useMemo(()=>{if(!_)return[];const t=_.toLowerCase();return M.filter(p=>p.name.toLowerCase().includes(t)||p.sku?.toLowerCase().includes(t)).slice(0,10)},[M,_]),K=t=>{if(d.some(p=>p.product_id===t.id)){L.warning(s("returns.already_added","Product already added"));return}A([...d,{product_id:t.id,product:t,quantity:1,unit_cost:t.cost_price||t.price,reason:""}]),g("")},Y=(t,p,b)=>{const Q=[...d];Q[t]={...Q[t],[p]:b},A(Q)},x=t=>{A(d.filter((p,b)=>b!==t))},U=a.useMemo(()=>d.reduce((t,p)=>t+p.quantity*p.unit_cost,0),[d]),z=C>0&&d.length>0&&d.every(t=>t.quantity>0),l=async()=>{if(z){c(!0),w(null);try{const t={supplier_id:C,reason:q||void 0,notes:P||void 0,items:d.map(p=>({product_id:p.product_id,quantity:p.quantity,unit_cost:p.unit_cost,reason:p.reason||void 0}))};await xe.create(t),L.success(s("returns.created","Return created successfully")),D()}catch(t){w(t instanceof Error?t.message:s("error.save_failed","Failed to create return"))}finally{c(!1)}}},h=[{value:"",label:s("common.select","Select reason...")},{value:"defective",label:s("returns.defective","Defective/Damaged")},{value:"wrong_item",label:s("returns.wrong_item","Wrong Item Received")},{value:"overstock",label:s("returns.overstock","Overstock")},{value:"expired",label:s("returns.expired","Expired")},{value:"other",label:s("returns.other","Other")}];return E?e.jsx(Z,{isOpen:o,onClose:v,title:s("returns.create","Create Supplier Return"),children:e.jsx("div",{className:"py-12",children:e.jsx(X,{})})}):e.jsx(Z,{isOpen:o,onClose:v,title:s("returns.create","Create Supplier Return"),size:"lg",children:e.jsxs("form",{onSubmit:t=>{t.preventDefault(),l()},children:[u&&e.jsx(ge,{message:u}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(k,{label:s("returns.supplier","Supplier"),required:!0,children:e.jsx(J,{value:C,onChange:t=>j(t),options:[{value:0,label:s("common.select","Select supplier...")},...i.map(t=>({value:t.id,label:t.name}))]})}),e.jsx(k,{label:s("returns.reason","Return Reason"),children:e.jsx(J,{value:q,onChange:t=>N(t),options:h})}),e.jsx(k,{label:s("returns.add_products","Add Products to Return"),children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:_,onChange:t=>g(t.target.value),className:"input",placeholder:s("returns.search_products","Search products...")}),_&&B.length>0&&e.jsx("div",{className:"absolute z-10 w-full mt-1 rounded-lg border shadow-lg max-h-48 overflow-auto",style:{backgroundColor:"var(--color-white)",borderColor:"var(--color-gray-200)"},children:B.map(t=>e.jsxs("button",{onClick:()=>K(t),className:"w-full p-3 text-start hover:bg-gray-50 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("div",{style:{color:"var(--color-gray-900)"},children:t.name}),e.jsx("div",{className:"text-sm",style:{color:"var(--color-gray-500)"},children:t.sku})]}),e.jsx("span",{style:{color:"var(--color-gray-600)"},children:y(t.cost_price||t.price)})]},t.id))})]})}),d.length>0&&e.jsx("div",{className:"border rounded-lg overflow-hidden",style:{borderColor:"var(--color-gray-200)"},children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{style:{backgroundColor:"var(--color-gray-50)"},children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-start",children:s("products.name","Product")}),e.jsx("th",{className:"px-4 py-2 text-center w-20",children:s("returns.qty","Qty")}),e.jsx("th",{className:"px-4 py-2 text-end w-28",children:s("returns.unit_cost","Unit Cost")}),e.jsx("th",{className:"px-4 py-2 text-end w-28",children:s("returns.subtotal","Subtotal")}),e.jsx("th",{className:"px-4 py-2 w-10"})]})}),e.jsx("tbody",{children:d.map((t,p)=>e.jsxs("tr",{className:"border-t",style:{borderColor:"var(--color-gray-100)"},children:[e.jsxs("td",{className:"px-4 py-2",children:[e.jsx("div",{style:{color:"var(--color-gray-900)"},children:t.product?.name}),e.jsx("input",{type:"text",value:t.reason,onChange:b=>Y(p,"reason",b.target.value),className:"input mt-1 text-xs",placeholder:s("returns.item_reason","Item reason...")})]}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"number",min:"1",value:t.quantity,onChange:b=>Y(p,"quantity",parseInt(b.target.value)||1),className:"input text-center w-16"})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"number",min:"0",step:"0.001",value:t.unit_cost,onChange:b=>Y(p,"unit_cost",parseFloat(b.target.value)||0),className:"input text-end w-24"})}),e.jsx("td",{className:"px-4 py-2 text-end font-medium",style:{color:"var(--color-gray-900)"},children:y(t.quantity*t.unit_cost)}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("button",{onClick:()=>x(p),className:"p-1 text-red-600 hover:bg-red-50 rounded",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})})]},t.product_id))}),e.jsx("tfoot",{style:{backgroundColor:"var(--color-gray-50)"},children:e.jsxs("tr",{className:"border-t",style:{borderColor:"var(--color-gray-200)"},children:[e.jsxs("td",{colSpan:3,className:"px-4 py-3 text-end font-semibold",children:[s("common.total","Total"),":"]}),e.jsx("td",{className:"px-4 py-3 text-end font-bold",style:{color:"var(--color-primary-600)"},children:y(U)}),e.jsx("td",{})]})})]})}),d.length===0&&e.jsx("div",{className:"py-8 text-center",style:{color:"var(--color-gray-500)"},children:s("returns.no_items","Search and add products to return")}),e.jsx(k,{label:s("returns.notes","Notes"),children:e.jsx("textarea",{value:P,onChange:t=>I(t.target.value),className:"input",rows:2,placeholder:s("returns.notes_placeholder","Additional notes...")})})]}),e.jsx(be,{onCancel:v,isSubmitting:W,submitLabel:s("returns.create","Create Return"),disabled:!z})]})})}function Ae(){const{t:o,locale:v}=se(),{hasPermission:D}=ye(),n=D("purchases.create")||D("purchases.manage"),s=D("purchases.return")||D("purchases.manage"),[f,i]=a.useState([]),[T,M]=a.useState(!0),[F,E]=a.useState({currentPage:1,totalPages:1,totalItems:0,perPage:15}),[R,C]=a.useState([]),[j,q]=a.useState(""),[N,P]=a.useState(""),[I,d]=a.useState(""),[A,_]=a.useState(!1),[g,W]=a.useState(null),[c,u]=a.useState(!1),w=a.useCallback(l=>new Intl.NumberFormat(v==="ar"?"ar-LY":"en-LY",{style:"currency",currency:"LYD",minimumFractionDigits:3}).format(l),[v]),y=a.useCallback(async()=>{M(!0);try{const l={page:F.currentPage,per_page:F.perPage,search:j||void 0,payment_status:N||void 0,supplier_id:I||void 0},h=await ae.list(l);i(h.data),E(t=>({...t,currentPage:h.meta.current_page,totalPages:h.meta.last_page,totalItems:h.meta.total}))}catch{L.error(o("error.load_failed","Failed to load purchase invoices"))}finally{M(!1)}},[F.currentPage,F.perPage,j,N,I,o]),B=a.useCallback(async()=>{try{const l=await re.listAll();C(l)}catch{}},[]);a.useEffect(()=>{y()},[y]),a.useEffect(()=>{B()},[B]),a.useEffect(()=>{E(l=>({...l,currentPage:1}))},[j,N,I]);const K=l=>{const h={unpaid:"default",partial:"warning",paid:"success"},t={unpaid:o("purchases.unpaid","Unpaid"),partial:o("purchases.partial_paid","Partial"),paid:o("purchases.paid","Paid")};return e.jsx(ne,{variant:h[l],dot:!0,children:t[l]})},Y=[{key:"invoice_number",header:o("purchases.invoice_number","Invoice #"),width:"140px",render:l=>e.jsx("button",{onClick:()=>W(l.id),className:"font-mono text-sm hover:underline",style:{color:"var(--color-primary-600)"},children:l.invoice_number})},{key:"supplier",header:o("purchases.supplier","Supplier"),render:l=>e.jsx("span",{style:{color:"var(--color-gray-900)"},children:l.supplier?.name||"-"})},{key:"supplier_invoice",header:o("purchases.supplier_invoice","Supplier Inv #"),hideOnMobile:!0,render:l=>e.jsx("span",{className:"font-mono text-sm",style:{color:"var(--color-gray-600)"},children:l.supplier_invoice_number||"-"})},{key:"total",header:o("purchases.total","Total"),align:"end",render:l=>e.jsx("span",{className:"font-semibold",style:{color:"var(--color-gray-900)"},children:w(l.total)})},{key:"payment_status",header:o("purchases.payment","Payment"),align:"center",width:"110px",render:l=>K(l.payment_status)},{key:"invoice_date",header:o("purchases.date","Date"),hideOnMobile:!0,render:l=>e.jsx("span",{style:{color:"var(--color-gray-600)"},children:new Date(l.invoice_date).toLocaleDateString(v)})},{key:"actions",header:"",align:"end",width:"80px",render:l=>e.jsx("div",{className:"flex items-center justify-end gap-1",children:e.jsx("button",{onClick:()=>W(l.id),className:"p-2 rounded-lg hover:bg-gray-100",title:o("common.view","View"),children:e.jsxs("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})]})})})}],x=[{value:"",label:o("common.all_status","All Status")},{value:"unpaid",label:o("purchases.unpaid","Unpaid")},{value:"partial",label:o("purchases.partial_paid","Partial")},{value:"paid",label:o("purchases.paid","Paid")}],U=[{value:"",label:o("common.all_suppliers","All Suppliers")},...R.map(l=>({value:l.id,label:l.name}))],z={unpaid:f.filter(l=>l.payment_status==="unpaid").length,partial:f.filter(l=>l.payment_status==="partial").length,paid:f.filter(l=>l.payment_status==="paid").length,total:f.reduce((l,h)=>l+Number(h.total),0)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold",style:{color:"var(--color-gray-900)"},children:o("nav.purchases","Purchase Invoices")}),e.jsx("p",{className:"text-sm mt-1",style:{color:"var(--color-gray-500)"},children:o("purchases.description","Record supplier invoices to increase inventory")})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[s&&e.jsxs("button",{onClick:()=>u(!0),className:"btn btn-secondary",children:[e.jsx("svg",{className:"w-5 h-5 me-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"})}),o("purchases.return","Return to Supplier")]}),n&&e.jsxs("button",{onClick:()=>_(!0),className:"btn btn-primary",children:[e.jsx("svg",{className:"w-5 h-5 me-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),o("purchases.record_purchase","Record Purchase")]})]})]}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx(ve,{value:j,onChange:q,placeholder:o("purchases.search_placeholder","Search by invoice # or supplier...")})}),e.jsx("div",{style:{minWidth:"150px"},children:e.jsx(J,{value:N,onChange:l=>P(l),options:x})}),e.jsx("div",{style:{minWidth:"180px"},children:e.jsx(J,{value:I,onChange:l=>d(l),options:U})})]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"card text-center",children:[e.jsx("div",{className:"text-2xl font-bold",style:{color:"var(--color-gray-600)"},children:z.unpaid}),e.jsx("div",{className:"text-sm",style:{color:"var(--color-gray-500)"},children:o("purchases.unpaid","Unpaid")})]}),e.jsxs("div",{className:"card text-center",children:[e.jsx("div",{className:"text-2xl font-bold",style:{color:"var(--color-warning-600)"},children:z.partial}),e.jsx("div",{className:"text-sm",style:{color:"var(--color-gray-500)"},children:o("purchases.partial_paid","Partial")})]}),e.jsxs("div",{className:"card text-center",children:[e.jsx("div",{className:"text-2xl font-bold",style:{color:"var(--color-success-600)"},children:z.paid}),e.jsx("div",{className:"text-sm",style:{color:"var(--color-gray-500)"},children:o("purchases.paid","Paid")})]}),e.jsxs("div",{className:"card text-center",children:[e.jsx("div",{className:"text-2xl font-bold",style:{color:"var(--color-primary-600)"},children:w(z.total)}),e.jsx("div",{className:"text-sm",style:{color:"var(--color-gray-500)"},children:o("purchases.page_total","Page Total")})]})]}),e.jsxs("div",{className:"p-4 rounded-lg border flex items-start gap-3",style:{backgroundColor:"var(--color-info-50)",borderColor:"var(--color-info-200)"},children:[e.jsx("svg",{className:"w-5 h-5 flex-shrink-0 mt-0.5",style:{color:"var(--color-info-600)"},fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsxs("div",{className:"text-sm",style:{color:"var(--color-info-800)"},children:[e.jsx("strong",{children:o("purchases.stock_note_title","Automatic Stock Updates:")})," ",o("purchases.stock_note","When you record a purchase invoice, inventory quantities are increased immediately.")]})]}),e.jsx("div",{className:"card p-0",children:e.jsx(je,{columns:Y,data:f,keyExtractor:l=>l.id,isLoading:T,emptyIcon:"ðŸ§¾",emptyTitle:o("purchases.empty","No purchase invoices found"),emptyDescription:o("purchases.empty_desc","Record your first purchase to add stock to inventory"),pagination:{...F,onPageChange:l=>E(h=>({...h,currentPage:l}))}})}),e.jsx(fe,{isOpen:A,onClose:()=>_(!1),onSuccess:()=>{_(!1),y()}}),e.jsx(Ne,{isOpen:g!==null,onClose:()=>W(null),invoiceId:g,onPaymentRecorded:()=>{y()}}),e.jsx(_e,{isOpen:c,onClose:()=>u(!1),onSuccess:()=>{u(!1),y()}})]})}export{Ae as PurchasesPage,Ae as default};
